name: K3-Standard-IPK-Final-Rebuild

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build Binary
        run: |
          # 1. 编译核心
          [ -f "go.mod" ] || go mod init ech-workers
          go mod tidy
          CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=7 \
          go build -trimpath -ldflags="-s -w" -o ech-workers ech-workers.go

      - name: Prepare Package
        run: |
          # 2. 建立临时打包目录
          mkdir -p ipk/CONTROL
          mkdir -p ipk/usr/bin
          mkdir -p ipk/etc/init.d
          mkdir -p ipk/etc/config
          mkdir -p ipk/usr/lib/lua/luci/controller
          mkdir -p ipk/usr/lib/lua/luci/model/cbi

          # 3. 填充文件
          cp ech-workers ipk/usr/bin/
          
          # 菜单入口 (Controller)
          cat <<EOF > ipk/usr/lib/lua/luci/controller/ech-workers.lua
          module("luci.controller.ech-workers", package.seeall)
          function index()
              entry({"admin", "services", "ech-workers"}, cbi("ech-workers"), _("ECH Workers Proxy"), 50).dependent = true
          end
          EOF

          # 界面逻辑 (Model)
          cat <<EOF > ipk/usr/lib/lua/luci/model/cbi/ech-workers.lua
          local m, s, o
          m = Map("ech-workers", "ECH Workers Proxy", "K3 ARMv7 标准安装版")
          s = m:section(TypedSection, "config", "设置")
          s.anonymous = true
          o = s:option(Flag, "enabled", "启用")
          o = s:option(Value, "server_addr", "Worker 域名")
          o = s:option(Value, "listen_addr", "监听地址")
          o.default = "0.0.0.0:30001"
          return m
          EOF

          # 基础配置
          echo "config ech-workers 'config'" > ipk/etc/config/ech-workers

          # 启动脚本
          cat <<EOF > ipk/etc/init.d/ech-workers
          #!/bin/sh /etc/rc.common
          START=99
          USE_PROCD=1
          start_service() {
              config_load ech-workers
              local enabled server_addr
              config_get_bool enabled config enabled 0
              [ "\$enabled" -eq 1 ] || return
              config_get server_addr config server_addr
              procd_open_instance
              procd_set_param command /usr/bin/ech-workers -w "\$server_addr" -l "0.0.0.0:30001"
              procd_set_param respawn
              procd_close_instance
          }
          EOF
          chmod 755 ipk/etc/init.d/ech-workers ipk/usr/bin/ech-workers

          # 4. 关键：编写极其标准的 CONTROL 文件
          # 删掉了所有复杂的 Depends，只保留最基础的信息
          cat <<EOF > ipk/CONTROL/control
          Package: luci-app-ech-workers
          Version: 2.0.0
          Architecture: arm_cortex-a9_vfpv3-d16
          Maintainer: Gemini
          Description: ECH Proxy for K3
          EOF

      - name: Standard IPK Packing
        run: |
          # 5. 按照标准 IPK 顺序打包
          cd ipk
          # 打包数据层
          tar -czf ../data.tar.gz --exclude=CONTROL .
          # 打包配置层
          cd CONTROL
          tar -czf ../../control.tar.gz .
          cd ../..
          # 打包外壳
          echo "2.0" > debian-binary
          # 使用通用的 tar 打包，不再使用 ar
          tar -cvzf luci-app-ech-workers_k3.ipk debian-binary data.tar.gz control.tar.gz
          mkdir -p deploy && mv luci-app-ech-workers_k3.ipk deploy/

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          files: deploy/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
