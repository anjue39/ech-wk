name: K3-Force-Menu-v2.3

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Build Binary (Static ARMv5)
        run: |
          [ -f "go.mod" ] || go mod init ech-workers
          go mod tidy
          CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=5 \
          go build -trimpath -ldflags="-s -w -extldflags '-static'" -o ech-workers ech-workers.go

      - name: Create Standard IPK
        run: |
          # 1. 准备文件系统
          mkdir -p staging/usr/bin staging/etc/init.d staging/etc/config \
                   staging/usr/lib/lua/luci/model/cbi \
                   staging/usr/lib/lua/luci/controller \
                   staging/usr/share/luci/menu.d \
                   staging/usr/share/rpcd/acl.d
          
          cp ech-workers staging/usr/bin/ && chmod +x staging/usr/bin/ech-workers

          # 【UI 逻辑】
          cat <<EOF > staging/usr/lib/lua/luci/model/cbi/ech-workers.lua
          local m, s, o
          m = Map("ech-workers", "ECH Workers Proxy", "K3 5.4内核 适配版")
          s = m:section(TypedSection, "config", "基本设置")
          s.anonymous = true
          o = s:option(Flag, "enabled", "启用")
          o = s:option(Value, "server_addr", "Worker 域名")
          o = s:option(Value, "listen_addr", "监听地址")
          o.default = "0.0.0.0:30001"
          return m
          EOF

          # 【菜单入口】双重保障
          cat <<EOF > staging/usr/lib/lua/luci/controller/ech-workers.lua
          module("luci.controller.ech-workers", package.seeall)
          function index()
              entry({"admin", "services", "ech-workers"}, cbi("ech-workers"), _("ECH Workers Proxy"), 50).dependent = true
          end
          EOF

          cat <<EOF > staging/usr/share/luci/menu.d/luci-app-ech-workers.json
          {
              "admin/services/ech-workers": {
                  "title": "ECH Workers Proxy",
                  "order": 50,
                  "action": { "type": "model", "path": "ech-workers" }
              }
          }
          EOF

          # 【ACL 权限】
          cat <<EOF > staging/usr/share/rpcd/acl.d/luci-app-ech-workers.json
          {
              "luci-app-ech-workers": {
                  "description": "Grant access to ECH Workers",
                  "read": { "cgi-bin": [ "luci" ], "uci": [ "ech-workers" ] },
                  "write": { "uci": [ "ech-workers" ] }
              }
          }
          EOF

          # 【配置与启动脚本】
          cat <<EOF > staging/etc/config/ech-workers
          config config 'config'
              option enabled '0'
              option server_addr ''
              option listen_addr '0.0.0.0:30001'
          EOF

          cat <<EOF > staging/etc/init.d/ech-workers
          #!/bin/sh /etc/rc.common
          START=99
          USE_PROCD=1
          start_service() {
              config_load ech-workers
              local enabled server_addr listen_addr
              config_get_bool enabled config enabled 0
              [ "\$enabled" -eq 1 ] || return 0
              config_get server_addr config server_addr
              config_get listen_addr config listen_addr "0.0.0.0:30001"
              procd_open_instance
              procd_set_param command /usr/bin/ech-workers -w "\$server_addr" -l "\$listen_addr"
              procd_set_param respawn
              procd_close_instance
          }
          EOF
          chmod +x staging/etc/init.d/ech-workers

          # 2. 准备控制逻辑 (核心修复：postinst)
          mkdir -p control
          cat <<EOF > control/control
          Package: luci-app-ech-workers
          Version: 2.3.0
          Architecture: all
          Depends: curl, ca-certificates
          Description: ECH-Workers with Force Auto-Index
          EOF

          # 【关键】安装后强制执行脚本
          cat <<EOF > control/postinst
          #!/bin/sh
          [ -n "\${IPKG_INSTROOT}" ] || {
              rm -f /tmp/luci-indexcache /tmp/luci-modulecache
              /etc/init.d/rpcd restart >/dev/null 2>&1
              /etc/init.d/uhttpd restart >/dev/null 2>&1
              exit 0
          }
          EOF
          chmod +x control/postinst

          # 3. 严格打包
          ( cd staging && tar --numeric-owner --group=0 --owner=0 -czf ../data.tar.gz . )
          ( cd control && tar --numeric-owner --group=0 --owner=0 -czf ../control.tar.gz . )
          echo "2.0" > debian-binary
          ar rc luci-app-ech-workers_k3.ipk debian-binary control.tar.gz data.tar.gz
          mkdir -p deploy && mv luci-app-ech-workers_k3.ipk deploy/

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          files: deploy/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
