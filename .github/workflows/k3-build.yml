name: K3-ECH-Pro-Full-Fixed-v3.6

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Build Binary (Fix go.mod & Illegal Instruction)
        run: |
          # 1. 克隆核心源码
          git clone https://github.com/byJoey/ech-wk.git core-src
          cd core-src
          
          # 2. 关键修复：手动初始化模块
          if [ ! -f "go.mod" ]; then
            go mod init ech-wk
          fi
          go mod tidy
          
          # 3. 针对 K3 (Cortex-A9) 编译：GOARM=5 解决非法指令
          CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=5 \
          go build -trimpath -ldflags="-s -w -extldflags '-static'" -o ../ech-workers .
          cd ..

      - name: Prepare Package Files
        run: |
          mkdir -p ipk/CONTROL ipk/usr/bin ipk/etc/init.d ipk/etc/config \
                   ipk/usr/lib/lua/luci/model/cbi ipk/usr/lib/lua/luci/controller

          cp ech-workers ipk/usr/bin/
          chmod 755 ipk/usr/bin/ech-workers

          # 1. Controller: 菜单与日志接口
          cat <<EOF > ipk/usr/lib/lua/luci/controller/ech-workers.lua
          module("luci.controller.ech-workers", package.seeall)
          function index()
              entry({"admin", "services", "ech-workers"}, cbi("ech-workers"), _("ECH Workers Proxy"), 50).dependent = true
              entry({"admin", "services", "ech-workers", "status"}, call("act_status")).leaf = true
              entry({"admin", "services", "ech-workers", "log"}, call("get_log")).leaf = true
          end

          function act_status()
              local sys = require "luci.sys"
              local running = sys.call("pidof ech-workers >/dev/null") == 0
              luci.http.prepare_content("application/json")
              luci.http.write_json({ running = running })
          end

          function get_log()
              local log = luci.util.exec("logread -e ech-workers | tail -n 50")
              luci.http.prepare_content("text/plain")
              luci.http.write(log or "暂无日志信息")
          end
          EOF

          # 2. Model: 界面、控制按钮与实时日志
          cat <<EOF > ipk/usr/lib/lua/luci/model/cbi/ech-workers.lua
          local m, s, o
          local sys = require "luci.sys"

          m = Map("ech-workers", "ECH Workers Proxy", "基于 Cloudflare Workers 的 ECH 代理 (K3 Pro版)")

          s = m:section(TypedSection, "config", "服务控制")
          s.anonymous = true
          local running = sys.call("pidof ech-workers >/dev/null") == 0
          if running then
              s.description = "<font color='green'><b>● 运行中</b></font>"
          else
              s.description = "<font color='red'><b>○ 未运行</b></font>"
          end

          s = m:section(NamedSection, "main", "config", "基本设置")
          s.addremove = false
          o = s:option(Flag, "enabled", "启用")
          o = s:option(Value, "server_addr", "服务器地址")
          o = s:option(Value, "listen_addr", "监听地址")
          o.default = "0.0.0.0:12580"
          o = s:option(Value, "token", "身份令牌")
          o.password = true

          s = m:section(NamedSection, "main", "config", "高级设置")
          o = s:option(Value, "up_address", "优选 IP/域名")
          o.default = "cf.090227.xyz"
          o = s:option(ListValue, "mode", "分流模式")
          o:value("global", "全局代理")
          o:value("bypass_china", "跳过中国大陆")
          o.default = "bypass_china"

          s = m:section(TypedSection, "config", "实时日志")
          s.anonymous = true
          o = s:option(DummyValue, "_log")
          o.rawhtml = true
          o.value = [[<textarea id="log_content" readonly="readonly" style="width: 100%; height: 200px; font-family: monospace; background: #000; color: #0f0; border: none; padding: 10px; font-size: 12px;"></textarea>
          <script type="text/javascript">
              function update_log() {
                  XHR.get(']] .. luci.dispatcher.build_url("admin", "services", "ech-workers", "log") .. [[', null, function(x, data) {
                      var e = document.getElementById('log_content');
                      if (e && data) { e.value = data; e.scrollTop = e.scrollHeight; }
                  });
              }
              setInterval(update_log, 4000);
              update_log();
          </script>]]

          return m
          EOF

          # 3. 初始化配置
          cat <<EOF > ipk/etc/config/ech-workers
          config config 'main'
              option enabled '0'
              option listen_addr '0.0.0.
