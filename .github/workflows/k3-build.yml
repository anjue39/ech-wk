name: K3-ECH-Full-Feature-Pro

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Build Binary (K3 Compatibility)
        run: |
          git clone https://github.com/byJoey/ech-wk.git core-src
          cd core-src
          go mod tidy
          CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=5 \
          go build -trimpath -ldflags="-s -w" -o ../ech-workers .
          cd ..

      - name: Prepare Files
        run: |
          mkdir -p ipk/CONTROL ipk/usr/bin ipk/etc/init.d ipk/etc/config \
                   ipk/usr/lib/lua/luci/model/cbi ipk/usr/lib/lua/luci/controller

          cp ech-workers ipk/usr/bin/
          chmod 755 ipk/usr/bin/ech-workers

          # 1. Controller: 增加日志和状态 API 接口
          cat <<EOF > ipk/usr/lib/lua/luci/controller/ech-workers.lua
          module("luci.controller.ech-workers", package.seeall)
          function index()
              entry({"admin", "services", "ech-workers"}, cbi("ech-workers"), _("ECH Workers Proxy"), 50).dependent = true
              entry({"admin", "services", "ech-workers", "status"}, call("act_status")).leaf = true
              entry({"admin", "services", "ech-workers", "log"}, call("get_log")).leaf = true
          end

          function act_status()
              local sys = require "luci.sys"
              local running = sys.call("pidof ech-workers >/dev/null") == 0
              luci.http.prepare_content("application/json")
              luci.http.write_json({ running = running })
          end

          function get_log()
              local fs = require "nixio.fs"
              -- 读取系统日志中关于 ech-workers 的部分
              local log = luci.util.exec("logread -e ech-workers | tail -n 50")
              luci.http.prepare_content("text/plain")
              luci.http.write(log or "暂无日志信息")
          end
          EOF

          # 2. Model: 复刻带按钮和日志窗口的 UI
          cat <<EOF > ipk/usr/lib/lua/luci/model/cbi/ech-workers.lua
          local m, s, o
          local sys = require "luci.sys"

          m = Map("ech-workers", "ECH Workers Proxy", "基于 Cloudflare Workers 的 ECH 代理服务")

          -- 服务控制区
          s = m:section(TypedSection, "config", "服务控制")
          s.anonymous = true
          s.template = "ech-workers/status_header" -- 需配合模板，此处先用描述替代
          
          local running = sys.call("pidof ech-workers >/dev/null") == 0
          if running then
              s.description = "<font color='green'><b>● 运行中</b></font>"
          else
              s.description = "<font color='red'><b>○ 未运行</b></font>"
          end

          -- 基本设置
          s = m:section(NamedSection, "main", "config", "基本设置")
          s.addremove = false

          o = s:option(Flag, "enabled", "启用")
          o.rmempty = false

          o = s:option(Value, "server_addr", "服务器地址", "格式：域名:端口")
          o.rmempty = false

          o = s:option(Value, "listen_addr", "监听地址")
          o.default = "0.0.0.0:12580"

          o = s:option(Value, "token", "身份令牌")
          o.password = true

          -- 高级设置
          s = m:section(NamedSection, "main", "config", "高级设置")
          o = s:option(Value, "up_address", "优选 IP/域名")
          o.default = "cf.090227.xyz"
          
          o = s:option(Value, "doh_url", "DoH 服务器")
          o.default = "dns.alidns.com/dns-query"
          
          o = s:option(Value, "ech_host", "ECH 域名")
          o.default = "cloudflare-ech.com"

          -- 日志展示区 (简单的日志文本框实现)
          s = m:section(TypedSection, "config", "运行日志")
          s.anonymous = true
          o = s:option(DummyValue, "_log")
          o.template = "ech-workers/log_view" -- 预留模板位置
          o.rawhtml = true
          o.value = [[<textarea id="log_content" readonly="readonly" style="width: 100%; height: 300px; font-family: monospace; background: #000; color: #0f0; border: none; padding: 10px;"></textarea>
          <script type="text/javascript">
              function update_log() {
                  XHR.get(']] .. luci.dispatcher.build_url("admin", "services", "ech-workers", "log") .. [[', null, function(x, data) {
                      var e = document.getElementById('log_content');
                      if (e && data) { e.value = data; e.scrollTop = e.scrollHeight; }
                  });
              }
              setInterval(update_log, 5000);
              update_log();
          </script>]]

          return m
          EOF

          # 3. 核心修复：初始化配置文件 (让配置项立刻显现)
          cat <<EOF > ipk/etc/config/ech-workers
          config config 'main'
              option enabled '0'
              option listen_addr '0.0.0.0:12580'
              option up_address 'cf.090227.xyz'
              option doh_url 'dns.alidns.com/dns-query'
              option ech_host 'cloudflare-ech.com'
          EOF

          # 4. 启动脚本 (Procd 管理与日志输出)
          cat <<EOF > ipk/etc/init.d/ech-workers
          #!/bin/sh /etc/rc.common
          START=99
          USE_PROCD=1
          start_service() {
              config_load ech-workers
              local enabled server_addr listen_addr token up_address
              config_get_bool enabled main enabled 0
              [ "\$enabled" -eq 1 ] || return
              config_get server_addr main server_addr
              config_get listen_addr main listen_addr "0.0.0.0:12580"
              config_get token main token
              config_get up_address main up_address "cf.090227.xyz"
              
              procd_open_instance
              procd_set_param command /usr/bin/ech-workers -w "\$server_addr" -l "\$listen_addr" -t "\$token" -up "\$up_address"
              procd_set_param respawn
              procd_set_param stdout 1 # 捕获日志到系统日志
              procd_set_param stderr 1
              procd_close_instance
          }
          EOF
          chmod 755 ipk/etc/init.d/ech-workers

          # 5. 打包
          cat <<EOF > ipk/CONTROL/control
          Package: luci-app-ech-workers
          Version: 3.5.0
          Architecture: all
          Description: K3 Pro version with Log View and Controls
          EOF

      - name: Build IPK
        run: |
          mkdir -p deploy
          cd ipk
          tar -czf ../data.tar.gz --exclude=CONTROL .
          cd CONTROL && tar -czf ../../control.tar.gz . && cd ../..
          echo "2.0" > debian-binary
          tar -czf luci-app-ech-workers_k3_pro_full.ipk debian-binary data.tar.gz control.tar.gz
          mv luci-app-ech-workers_k3_pro_full.ipk deploy/

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          files: deploy/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
