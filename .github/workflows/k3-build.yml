name: K3-Go-IPK-Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: # 必须开启写入权限，否则无法发布 Release
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'
          cache: true

      - name: Build Binary (ARMv7 Static)
        run: |
          # 1. 确保在源码根目录下初始化 Go 环境
          if [ ! -f "go.mod" ]; then
            go mod init ech-workers
          fi
          
          # 2. 自动下载缺失的依赖 (如 gorilla/websocket)
          go mod tidy
          
          # 3. 执行静态编译
          CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=7 \
          go build -trimpath -ldflags="-s -w" -o ech-workers ech-workers.go
          
          # 4. 准备打包目录结构
          mkdir -p luci/root/usr/bin/
          cp ech-workers luci/root/usr/bin/
          chmod +x luci/root/usr/bin/ech-workers

      - name: Build IPK via SDK
        uses: immortalwrt/gh-action-sdk@master
        with:
          architecture: arm_cortex-a9_vfpv3-d16
          pkgdir: luci

      - name: Collect IPK Files
        run: |
          mkdir -p deploy
          find bin/targets/ -name "*.ipk" -exec cp {} deploy/ \;
          echo "UPLOAD_PATH=deploy" >> $GITHUB_ENV

      - name: Create Release and Upload
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: K3 专用版 ECH-Workers v${{ github.run_number }}
          body: |
            这是专为斐讯 K3 (ARMv7) 编译的静态版 ECH-Workers。
            - 核心已包含在 IPK 内，无需联网下载。
            - 采用 GOARM=7 静态编译，解决运行报错问题。
          files: deploy/*.ipk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
