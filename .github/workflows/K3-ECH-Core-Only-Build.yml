name: K3-ECH-Core-Only-Build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Build K3 Compatible Binary
        run: |
          # 1. 克隆核心源码
          git clone https://github.com/byJoey/ech-wk.git core-src
          cd core-src
          
          # 2. 核心修复：手动初始化 Go 模块 (解决 go.mod file not found)
          # 如果不存在 go.mod，则强制创建一个，模块名设为 ech-wk
          if [ ! -f "go.mod" ]; then
            go mod init ech-wk
          fi
          
          # 3. 整理依赖
          go mod tidy
          
          # 4. 编译参数适配 K3 (ARMv7 / Cortex-A9)
          # 使用 GOARM=5 彻底解决 Illegal instruction 报错
          # CGO_ENABLED=0 确保静态链接，不依赖路由器系统库
          CGO_ENABLED=0 GOOS=linux GOARCH=arm GOARM=5 \
          go build -trimpath -ldflags="-s -w -extldflags '-static'" -o ../ech-workers-k3 .
          
          cd ..

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: core-v${{ github.run_number }}
          name: K3-Core-Only-v${{ github.run_number }}
          files: ech-workers-k3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
